<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Painel - Espia WhatsApp</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/painel.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>
<body>
    <div class="container">
        <header>
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo Espia WhatsApp" class="logo">
            <p class="slogan">Controle total das conversas com segurança!</p>
        </header>
        <main>
            <section class="painel-section">
                <h2>Painel de Monitoramento</h2>
                <div class="info-user">
                    <p><strong>Usuário:</strong> {{ session_id }}</p>
                    <p><strong>Plano:</strong> {{ plano }}</p>
                    <p><strong>Limite de WhatsApps:</strong> {{ max_filhos }}</p>
                    <p><strong>WhatsApps cadastrados:</strong> {{ filhos|length }}</p>
                    {% if dias_restantes is not none %}
                        <p><strong>Dias restantes (teste gratuito):</strong> {{ dias_restantes }}</p>
                    {% endif %}
                    {% if comprar_agora %}
                        <div class="comprar-agora">
                            <p>Seu teste gratuito expirou! Escolha um plano para continuar:</p>
                            <a href="https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=2c93808497db5aae0197e4eee8990326" class="btn-plano">Plano Pro (R$ 38,90/mês - 1 celular)</a>
                            <a href="https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=2c93808497e081eb0197e4f713f8015a" class="btn-plano">Plano Premium (R$ 99,70/mês - 3 celulares)</a>
                        </div>
                    {% elif plano == "Pro" %}
                        <p class="upgrade-discreto">
                            Quer monitorar mais celulares? <a href="https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=2c93808497e081eb0197e4f713f8015a">Faça upgrade para o Plano Premium (R$ 99,70/mês - 3 celulares)</a>
                        </p>
                    {% endif %}
                </div>
                {% if mensagem_confirmacao %}
                    <p class="mensagem-confirmacao">{{ mensagem_confirmacao }}</p>
                {% endif %}
                {% if erro %}
                    <p class="erro">{{ erro }}</p>
                {% endif %}
                <h3>WhatsApps Monitorados</h3>
                {% if filhos %}
                    <ul class="filho-lista">
                        {% for filho in filhos %}
                            <li id="linha-{{ filho.numero_whatsapp }}">
                                <span>{{ filho.nome_filho }} ({{ filho.numero_whatsapp }})</span>
                                <span class="status" id="status-{{ filho.numero_whatsapp }}">Verificando...</span>
                                <button type="button" class="btn-conectar" id="btn-conectar-{{ filho.numero_whatsapp }}" onclick="conectar('{{ filho.numero_whatsapp }}')">Conectar</button>
                                <button type="button" class="btn-desconectar" id="btn-desconectar-{{ filho.numero_whatsapp }}" onclick="desconectar('{{ filho.numero_whatsapp }}')" style="display: none;">Desconectar</button>
                                <div class="qrcode-area" id="qrcode-{{ filho.numero_whatsapp }}"></div>
                                <form method="post" action="{{ url_for('excluir_filho', filho_id=filho.id) }}" style="display:inline;">
                                    <button type="submit" class="btn-excluir">Excluir</button>
                                </form>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Nenhum WhatsApp cadastrado ainda.</p>
                {% endif %}
                {% if filhos|length < max_filhos and not comprar_agora %}
                    <h3>Adicionar Novo WhatsApp</h3>
                    <form method="post" action="{{ url_for('adicionar_filho') }}" class="add-filho-form">
                        <label for="nome_filho">Nome do Filho:</label>
                        <input type="text" name="nome_filho" id="nome_filho" required placeholder="Nome do filho">
                        <label for="numero">Número do WhatsApp (com DDI, ex.: +5512345678900):</label>
                        <input type="text" name="numero" id="numero" required placeholder="+5512345678900">
                        <button type="submit" class="btn-add">Adicionar</button>
                    </form>
                {% else %}
                    <p class="limite">Limite de WhatsApps atingido para o seu plano.</p>
                {% endif %}
                <div class="logout-container">
                    <p class="logout-link"><a href="{{ url_for('logout') }}">Sair</a></p>
                </div>
            </section>
        </main>
        <footer>
            <p>© 2025 Espia WhatsApp. Todos os direitos reservados.</p>
        </footer>
    </div>
    <script>
        const numeros = {{ filhos | tojson }};
        const clickCooldowns = {};

        function atualizarStatus() {
            const lista = numeros.map(f => f.numero_whatsapp);
            fetch("/status-conexao", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ numeros: lista })
            })
            .then(r => r.json())
            .then(statuses => {
                for (const [numero, status] of Object.entries(statuses)) {
                    const elStatus = document.getElementById(`status-${numero}`);
                    const elConectar = document.getElementById(`btn-conectar-${numero}`);
                    const elDesconectar = document.getElementById(`btn-desconectar-${numero}`);
                    const elQrcode = document.getElementById(`qrcode-${numero}`);
                    if (elStatus) {
                        elStatus.innerText = status ? "Conectado" : "Desconectado";
                    }
                    if (status) {
                        if (elConectar) elConectar.style.display = "none";
                        if (elDesconectar) elDesconectar.style.display = "inline-block";
                        if (elQrcode) elQrcode.innerHTML = "";
                    } else {
                        if (elConectar) elConectar.style.display = "inline-block";
                        if (elDesconectar) elDesconectar.style.display = "none";
                    }
                }
            });
        }

        function conectar(numero) {
            if (clickCooldowns[numero] && Date.now() - clickCooldowns[numero] < 5000) {
                return;
            }
            clickCooldowns[numero] = Date.now();
            const btn = document.getElementById(`btn-conectar-${numero}`);
            if (btn) {
                btn.disabled = true;
                setTimeout(() => { btn.disabled = false; }, 5000);
            }
            fetch(`/solicitar-qrcode/${numero}`)
                .then(r => r.json())
                .then(data => {
                    const el = document.getElementById(`qrcode-${numero}`);
                    if (el && data.qrcode) {
                        el.innerHTML = `<img src="${data.qrcode}" width="200">`;
                    } else {
                        el.innerText = "Erro ao gerar QR code.";
                    }
                });
        }

        function desconectar(numero) {
            if (clickCooldowns[numero] && Date.now() - clickCooldowns[numero] < 5000) {
                return;
            }
            clickCooldowns[numero] = Date.now();
            const btn = document.getElementById(`btn-desconectar-${numero}`);
            if (btn) {
                btn.disabled = true;
                setTimeout(() => { btn.disabled = false; }, 5000);
            }
            fetch(`/desconectar/${numero}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === "sessão desconectada com sucesso") {
                    const elStatus = document.getElementById(`status-${numero}`);
                    const elConectar = document.getElementById(`btn-conectar-${numero}`);
                    const elDesconectar = document.getElementById(`btn-desconectar-${numero}`);
                    const elQrcode = document.getElementById(`qrcode-${numero}`);
                    if (elStatus) elStatus.innerText = "Desconectado";
                    if (elConectar) elConectar.style.display = "inline-block";
                    if (elDesconectar) elDesconectar.style.display = "none";
                    if (elQrcode) elQrcode.innerHTML = "";
                }
            });
        }

        setInterval(atualizarStatus, 5000);
        atualizarStatus();
    </script>
</body>
</html>
