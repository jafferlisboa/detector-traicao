<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="light">
    <title>Painel - Espia WhatsApp</title>
    <style>* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Arial', sans-serif;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
}

body {
    background: #fbf7f4 !important;
    color: #333;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
}

.container {
    max-width: 1000px;
    width: 98%;
    padding: 30px;
    text-align: center;
    background: #fbf7f4;
}

header {
    margin-bottom: 15px;
    background: #fbf7f4;
}

.logo-container {
    background: #fbf7f4;
    padding: 15px;
    border-radius: 10px;
    border-bottom: 2px solid #1e3c72;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: inline-block;
}

.logo {
    max-width: 250px;
    height: auto;
}

.slogan {
    font-size: 1.3em;
    color: #555;
    margin-top: 15px;
    font-style: italic;
}

.painel-section {
    background: #e0e0e0;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
    border: 1px solid #ccc;
}

h2, h3 {
    font-size: 2em;
    margin-bottom: 20px;
    color: #1e3c72;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
}

.info-user {
    display: flex;
    flex-wrap: wrap;
    gap: 25px;
    justify-content: center;
    margin-bottom: 25px;
}

.info-user p {
    font-size: 1.1em;
    color: #555;
}

.comprar-agora {
    background: rgba(255, 215, 0, 0.2);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 25px;
}

.btn-plano {
    display: inline-block;
    padding: 12px 25px;
    margin: 10px;
    background: #ffd700;
    color: #1e3c72;
    text-decoration: none;
    border-radius: 8px;
    transition: background 0.3s, transform 0.2s;
}

.btn-plano:hover {
    background: #e6c200;
    transform: scale(1.05);
}

.upgrade-discreto {
    font-size: 1em;
    color: #555;
    margin-top: 15px;
}

.upgrade-discreto a {
    color: #1e3c72;
    text-decoration: none;
    transition: color 0.3s;
}

.upgrade-discreto a:hover {
    color: #0d1a3b;
    text-decoration: underline;
}

.mensagem-confirmacao {
    color: #1e3c72;
    background: rgba(255, 215, 0, 0.2);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.erro {
    color: #ff4d4d;
    background: rgba(255, 0, 0, 0.2);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.filho-lista {
    list-style: none;
    margin-bottom: 25px;
}

.filho-lista li {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.8);
    border-radius: 8px;
    margin-bottom: 15px;
    flex-wrap: wrap;
    transition: transform 0.2s;
}

.filho-lista li:hover {
    transform: scale(1.02);
}

.status {
    font-weight: bold;
    color: #1e3c72;
}

.qrcode-area img {
    margin-top: 15px;
    border: 1px solid #ccc;
    border-radius: 8px;
    filter: drop-shadow(0 2px 5px rgba(0, 0, 0, 0.2));
}

.btn-conectar, .btn-desconectar, .btn-excluir, .btn-add {
    padding: 10px 20px;
    font-size: 1em;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
}

.btn-conectar {
    background: #28a745;
    color: #fff;
}

.btn-conectar:hover {
    background: #218838;
    transform: scale(1.05);
}

.btn-desconectar {
    background: #dc3545;
    color: #fff;
}

.btn-desconectar:hover {
    background: #c82333;
    transform: scale(1.05);
}

.btn-excluir {
    background: #ff4d4d;
    color: #fff;
}

.btn-excluir:hover {
    background: #e63946;
    transform: scale(1.05);
}

.btn-add {
    background: #ffd700;
    color: #1e3c72;
}

.btn-add:hover {
    background: #e6c200;
    transform: scale(1.05);
}

.add-filho-form {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 25px;
}

label {
    font-size: 1.1em;
    color: #555;
    text-align: left;
    margin-bottom: 8px;
}

input {
    padding: 15px;
    font-size: 1.1em;
    border: none;
    border-radius: 8px;
    background: #f5f5f5;
    color: #333;
    outline: none;
    transition: box-shadow 0.3s, transform 0.2s;
}

input:focus {
    box-shadow: 0 0 10px #1e3c72;
    transform: scale(1.02);
}

.limite {
    color: #ff4d4d;
    margin-top: 25px;
}

.logout-container {
    text-align: right;
    margin-top: 30px;
}

.logout-link a {
    color: #1e3c72;
    text-decoration: none;
    font-weight: bold;
    transition: color 0.3s;
}

.logout-link a:hover {
    color: #0d1a3b;
    text-decoration: underline;
}

footer {
    margin-top: 40px;
    font-size: 1em;
    color: #555;
}

@media (max-width: 768px) {
    body { background: #fbf7f4 !important; }
    .container { max-width: 98%; padding: 20px; background: #fbf7f4; }
    .logo-container { padding: 10px; }
    h2, h3 { font-size: 1.7em; }
    .painel-section { padding: 30px; }
    .info-user { flex-direction: column; gap: 15px; }
    .filho-lista li { flex-direction: column; align-items: flex-start; }
    input, .btn-conectar, .btn-desconectar, .btn-excluir, .btn-add { font-size: 1em; padding: 12px; }
    .btn-plano { font-size: 1em; padding: 10px 20px; }
}</style>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="{{ url_for('static', filename='logo2.png') }}" alt="Logo Espia WhatsApp" class="logo">
            </div>
            <p class="slogan">Controle total das conversas com segurança!</p>
        </header>
        <main>
            <section class="painel-section">
                <h2>Painel de Monitoramento</h2>
                <div class="info-user">
                    <p><strong>Usuário:</strong> {{ session_id }}</p>
                    <p><strong>Plano:</strong> {{ plano }}</p>
                    <p><strong>Limite de WhatsApps:</strong> {{ max_filhos }}</p>
                    <p><strong>WhatsApps cadastrados:</strong> {{ filhos|length }}</p>
                    {% if dias_restantes is not none %}
                        <p><strong>Dias restantes (teste gratuito):</strong> {{ dias_restantes }}</p>
                    {% endif %}
                    {% if comprar_agora %}
                        <div class="comprar-agora">
                            <p>Seu teste gratuito expirou! Escolha um plano para continuar:</p>
                            <a href="https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=2c93808497db5aae0197e4eee8990326" class="btn-plano">Plano Pro (R$ 38,90/mês - 1 celular)</a>
                            <a href="https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=2c93808497e081eb0197e4f713f8015a" class="btn-plano">Plano Premium (R$ 99,70/mês - 3 celulares)</a>
                        </div>
                    {% elif plano == "Pro" %}
                        <p class="upgrade-discreto">
                            Quer monitorar mais celulares? <a href="https://www.mercadopago.com.br/subscriptions/checkout?preapproval_plan_id=2c93808497e081eb0197e4f713f8015a">Faça upgrade para o Plano Premium (R$ 99,70/mês - 3 celulares)</a>
                        </p>
                    {% endif %}
                </div>
                {% if mensagem_confirmacao %}
                    <p class="mensagem-confirmacao">{{ mensagem_confirmacao }}</p>
                {% endif %}
                {% if erro %}
                    <p class="erro">{{ erro }}</p>
                {% endif %}
                <h3>WhatsApps Monitorados</h3>
                {% if filhos %}
                    <ul class="filho-lista">
                        {% for filho in filhos %}
                            <li id="linha-{{ filho.numero_whatsapp }}">
                                <span>{{ filho.nome_filho }} ({{ filho.numero_whatsapp }})</span>
                                <span class="status" id="status-{{ filho.numero_whatsapp }}">Verificando...</span>
                                <button type="button" class="btn-conectar" id="btn-conectar-{{ filho.numero_whatsapp }}" onclick="conectar('{{ filho.numero_whatsapp }}')">Conectar</button>
                                <button type="button" class="btn-desconectar" id="btn-desconectar-{{ filho.numero_whatsapp }}" onclick="desconectar('{{ filho.numero_whatsapp }}')" style="display: none;">Desconectar</button>
                                <div class="qrcode-area" id="qrcode-{{ filho.numero_whatsapp }}"></div>
                                <form method="post" action="{{ url_for('excluir_filho', filho_id=filho.id) }}" style="display:inline;">
                                    <button type="submit" class="btn-excluir">Excluir</button>
                                </form>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>Nenhum WhatsApp cadastrado ainda.</p>
                {% endif %}
                {% if filhos|length < max_filhos and not comprar_agora %}
                    <h3>Adicionar Novo WhatsApp</h3>
                    <form method="post" action="{{ url_for('adicionar_filho') }}" class="add-filho-form">
                        <label for="nome_filho">Nome do Filho:</label>
                        <input type="text" name="nome_filho" id="nome_filho" required placeholder="Nome do filho">
                        <label for="numero">Número do WhatsApp (com DDI, ex.: +5512345678900):</label>
                        <input type="text" name="numero" id="numero" required placeholder="+5512345678900">
                        <button type="submit" class="btn-add">Adicionar</button>
                    </form>
                {% else %}
                    <p class="limite">Limite de WhatsApps atingido para o seu plano.</p>
                {% endif %}
                <div class="logout-container">
                    <p class="logout-link"><a href="{{ url_for('logout') }}">Sair</a></p>
                </div>
            </section>
        </main>
        <footer>
            <p>© 2025 Espia WhatsApp. Todos os direitos reservados.</p>
        </footer>
    </div>
    <script>
        const numeros = {{ filhos | tojson }};
        const clickCooldowns = {};

        function atualizarStatus() {
            const lista = numeros.map(f => f.numero_whatsapp);
            fetch("/status-conexao", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ numeros: lista })
            })
            .then(r => r.json())
            .then(statuses => {
                for (const [numero, status] of Object.entries(statuses)) {
                    const elStatus = document.getElementById(`status-${numero}`);
                    const elConectar = document.getElementById(`btn-conectar-${numero}`);
                    const elDesconectar = document.getElementById(`btn-desconectar-${numero}`);
                    const elQrcode = document.getElementById(`qrcode-${numero}`);
                    if (elStatus) {
                        elStatus.innerText = status ? "Conectado" : "Desconectado";
                    }
                    if (status) {
                        if (elConectar) elConectar.style.display = "none";
                        if (elDesconectar) elDesconectar.style.display = "inline-block";
                        if (elQrcode) elQrcode.innerHTML = "";
                    } else {
                        if (elConectar) elConectar.style.display = "inline-block";
                        if (elDesconectar) elDesconectar.style.display = "none";
                    }
                }
            });
        }

        function conectar(numero) {
            if (clickCooldowns[numero] && Date.now() - clickCooldowns[numero] < 5000) {
                return;
            }
            clickCooldowns[numero] = Date.now();
            const btn = document.getElementById(`btn-conectar-${numero}`);
            if (btn) {
                btn.disabled = true;
                setTimeout(() => { btn.disabled = false; }, 5000);
            }
            fetch(`/solicitar-qrcode/${numero}`)
                .then(r => r.json())
                .then(data => {
                    const el = document.getElementById(`qrcode-${numero}`);
                    if (el && data.qrcode) {
                        el.innerHTML = `<img src="${data.qrcode}" width="200">`;
                    } else {
                        el.innerText = "Erro ao gerar QR code.";
                    }
                });
        }

        function desconectar(numero) {
            if (clickCooldowns[numero] && Date.now() - clickCooldowns[numero] < 5000) {
                return;
            }
            clickCooldowns[numero] = Date.now();
            const btn = document.getElementById(`btn-desconectar-${numero}`);
            if (btn) {
                btn.disabled = true;
                setTimeout(() => { btn.disabled = false; }, 5000);
            }
            fetch(`/desconectar/${numero}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" }
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === "sessão desconectada com sucesso") {
                    const elStatus = document.getElementById(`status-${numero}`);
                    const elConectar = document.getElementById(`btn-conectar-${numero}`);
                    const elDesconectar = document.getElementById(`btn-desconectar-${numero}`);
                    const elQrcode = document.getElementById(`qrcode-${numero}`);
                    if (elStatus) elStatus.innerText = "Desconectado";
                    if (elConectar) elConectar.style.display = "inline-block";
                    if (elDesconectar) elDesconectar.style.display = "none";
                    if (elQrcode) elQrcode.innerHTML = "";
                }
            });
        }

        setInterval(atualizarStatus, 5000);
        atualizarStatus();
    </script>
</body>
</html>
